<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banking Portfolio Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .nav-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .metric-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .chart-canvas {
            max-height: 400px;
        }

        .data-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .table-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .risk-high {
            color: #e74c3c;
            font-weight: bold;
        }

        .risk-medium {
            color: #f39c12;
            font-weight: bold;
        }

        .risk-low {
            color: #27ae60;
            font-weight: bold;
        }

        .sheet-content {
            display: none;
        }

        .sheet-content.active {
            display: block;
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                min-width: auto;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .nav-container {
                flex-direction: column;
                align-items: center;
            }

            .nav-btn {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>Banking Portfolio Dashboard</h1>
            <p>Comprehensive analysis of loan concentrations and risk metrics</p>
            
            <div id="navigation" class="nav-container" style="display: none;">
                <button class="nav-btn active" data-sheet="ci" onclick="dashboard.switchSheet('ci')">
                    C&I Concentration
                </button>
                <button class="nav-btn" data-sheet="cre" onclick="dashboard.switchSheet('cre')">
                    CRE Concentration
                </button>
                <button class="nav-btn" data-sheet="overview" onclick="dashboard.switchSheet('overview')">
                    Portfolio Overview
                </button>
            </div>
        </div>

        <div id="file-upload" class="loading">
            <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; max-width: 500px; margin: 0 auto; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);">
                <h2 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">Upload Excel File</h2>
                <p style="color: #7f8c8d; margin-bottom: 30px; text-align: center;">Please select your banking data Excel file</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="width: 100%; padding: 15px; border: 2px dashed #bdc3c7; border-radius: 10px; background: #f8f9fa; cursor: pointer; font-size: 16px;">
                <div id="upload-status" style="margin-top: 20px; text-align: center; color: #7f8c8d;"></div>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <p>Processing banking data...</p>
        </div>

        <div id="dashboard-content" style="display: none;">
            <!-- C&I Concentration Sheet -->
            <div id="ci-content" class="sheet-content active">
                <div class="metrics-grid" id="ci-metrics-grid"></div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">C&I Industry Concentration by Book Balance</h3>
                        <canvas id="ciIndustryChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">C&I Capital Utilization by Industry</h3>
                        <canvas id="ciCapitalChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">C&I Risk Distribution</h3>
                        <canvas id="ciRiskChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">C&I Lending Capacity Utilization</h3>
                        <canvas id="ciCapacityChart" class="chart-canvas"></canvas>
                    </div>
                </div>
                <div class="data-table">
                    <h3 class="table-title">Detailed C&I Industry Analysis</h3>
                    <table id="ciIndustryTable">
                        <thead>
                            <tr>
                                <th>Industry</th>
                                <th>Book Balance</th>
                                <th>Total Exposure</th>
                                <th>% of Capital</th>
                                <th>Risk Level</th>
                                <th>Remaining Capacity</th>
                            </tr>
                        </thead>
                        <tbody id="ciIndustryTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- CRE Concentration Sheet -->
            <div id="cre-content" class="sheet-content">
                <div class="metrics-grid" id="cre-metrics-grid"></div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">CRE Property Type Concentration</h3>
                        <canvas id="creTypeChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">CRE Geographic Distribution</h3>
                        <canvas id="creGeoChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">CRE Risk Assessment</h3>
                        <canvas id="creRiskChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">CRE Loan-to-Value Distribution</h3>
                        <canvas id="creLtvChart" class="chart-canvas"></canvas>
                    </div>
                </div>
                <div class="data-table">
                    <h3 class="table-title">Detailed CRE Analysis</h3>
                    <table id="creTable">
                        <thead>
                            <tr>
                                <th>Property Type/Location</th>
                                <th>Outstanding Balance</th>
                                <th>Number of Loans</th>
                                <th>% of Portfolio</th>
                                <th>Average LTV</th>
                                <th>Risk Category</th>
                            </tr>
                        </thead>
                        <tbody id="creTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Portfolio Overview Sheet -->
            <div id="overview-content" class="sheet-content">
                <div class="metrics-grid" id="overview-metrics-grid"></div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">Portfolio Composition</h3>
                        <canvas id="portfolioCompositionChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Risk Comparison: C&I vs CRE</h3>
                        <canvas id="riskComparisonChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Concentration Limits Monitor</h3>
                        <canvas id="limitsChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Problem Assets Overview</h3>
                        <canvas id="problemAssetsChart" class="chart-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="error-container"></div>
    </div>

    <script>
        class BankingDashboard {
            constructor() {
                this.data = {
                    ciConcentration: [],
                    creConcentration: [],
                    classifiedLoans: [],
                    nonAccrualLoans: [],
                    famConcentration: []
                };
                this.charts = {};
                this.currentSheet = 'ci';
                window.dashboard = this;
            }

            async init() {
                this.setupFileUpload();
            }

            setupFileUpload() {
                const fileInput = document.getElementById('fileInput');
                const uploadStatus = document.getElementById('upload-status');

                fileInput.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        uploadStatus.textContent = 'Processing file...';
                        uploadStatus.style.color = '#3498db';
                        
                        try {
                            await this.processFile(file);
                            this.processAllData();
                            this.renderAllContent();
                            this.showDashboard();
                        } catch (error) {
                            uploadStatus.textContent = `Error: ${error.message}`;
                            uploadStatus.style.color = '#e74c3c';
                        }
                    }
                });
            }

            async processFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {
                                cellStyles: true,
                                cellFormulas: true,
                                cellDates: true,
                                cellNF: true,
                                sheetStubs: true
                            });

                            this.loadDataFromWorkbook(workbook);
                            resolve();
                        } catch (error) {
                            reject(new Error(`Failed to process Excel file: ${error.message}`));
                        }
                    };

                    reader.onerror = () => {
                        reject(new Error('Failed to read file'));
                    };

                    reader.readAsArrayBuffer(file);
                });
            }

            loadDataFromWorkbook(workbook) {
                this.data = {
                    ciConcentration: [],
                    creConcentration: [],
                    classifiedLoans: [],
                    nonAccrualLoans: [],
                    famConcentration: []
                };

                // Process C&I Concentration data
                if (workbook.Sheets["C&I Concentration"]) {
                    const ciSheet = workbook.Sheets["C&I Concentration"];
                    const ciRawData = XLSX.utils.sheet_to_json(ciSheet, { header: 1 });
                    
                    let headerRowIndex = -1;
                    for (let i = 0; i < ciRawData.length; i++) {
                        if (ciRawData[i][0] === "Row Labels") {
                            headerRowIndex = i;
                            break;
                        }
                    }

                    if (headerRowIndex !== -1) {
                        const headers = ciRawData[headerRowIndex];
                        for (let i = headerRowIndex + 1; i < ciRawData.length; i++) {
                            const row = ciRawData[i];
                            if (row && row.some(cell => cell !== null && cell !== undefined && cell !== "")) {
                                const rowObj = {};
                                headers.forEach((header, index) => {
                                    if (header && row[index] !== undefined) {
                                        rowObj[header] = row[index];
                                    }
                                });
                                if (rowObj["Row Labels"] && 
                                    !rowObj["Row Labels"].toString().toLowerCase().includes('grand total') &&
                                    !rowObj["Row Labels"].toString().toLowerCase().includes('total')) {
                                    this.data.ciConcentration.push(rowObj);
                                }
                            }
                        }
                    }
                }

                // Process CRE Concentration data
                if (workbook.Sheets["CRE Concentration"]) {
                    const creSheet = workbook.Sheets["CRE Concentration"];
                    const creRawData = XLSX.utils.sheet_to_json(creSheet, { header: 1 });
                    
                    // Log the first few rows to understand the structure
                    console.log("CRE Sheet first 10 rows:", creRawData.slice(0, 10));
                    
                    for (let i = 0; i < creRawData.length; i++) {
                        const row = creRawData[i];
                        if (row && row[0] && typeof row[0] === 'string' && 
                            !row[0].includes('Androscoggin Bank') && 
                            !row[0].includes('Commercial Real Estate') &&
                            !row[0].includes('Bank Capital') &&
                            !row[0].toLowerCase().includes('grand total') &&
                            !row[0].toLowerCase().includes('total') &&
                            row[0] !== '') {
                            
                            // Try multiple columns for LTV data
                            let ltvValue = 0;
                            for (let j = 4; j < Math.min(row.length, 10); j++) {
                                const potentialLTV = this.parseNumber(row[j]);
                                // Look for values that could be LTV (typically 0-100 range, or 0-1 if decimal)
                                if (potentialLTV > 0 && potentialLTV <= 100) {
                                    ltvValue = potentialLTV;
                                    break;
                                } else if (potentialLTV > 0 && potentialLTV <= 1) {
                                    ltvValue = potentialLTV * 100; // Convert decimal to percentage
                                    break;
                                }
                            }
                            
                            const creItem = {
                                "Property Type": row[0],
                                "Outstanding Balance": this.parseNumber(row[1]),
                                "Number of Loans": this.parseNumber(row[2]),
                                "Percentage": this.parseNumber(row[3]),
                                "Average LTV": ltvValue
                            };
                            
                            // Debug: Log the LTV values to see what we're getting
                            if (creItem["Property Type"] && creItem["Outstanding Balance"] > 0) {
                                console.log(`CRE Item: ${creItem["Property Type"]}, LTV: ${creItem["Average LTV"]}, Raw row:`, row);
                                this.data.creConcentration.push(creItem);
                            }
                        }
                    }
                }

                // Process other sheets
                ["Classified Loans_2", "Non Accrual Loans_4", "1-4 Fam Inv Concentration"].forEach(sheetName => {
                    if (workbook.Sheets[sheetName]) {
                        const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                        const nonEmptyRows = sheetData.filter(row => row && row.some(cell => cell !== null && cell !== undefined && cell !== ""));
                        
                        if (sheetName === "Classified Loans_2") {
                            this.data.classifiedLoans = nonEmptyRows;
                        } else if (sheetName === "Non Accrual Loans_4") {
                            this.data.nonAccrualLoans = nonEmptyRows;
                        } else if (sheetName === "1-4 Fam Inv Concentration") {
                            this.data.famConcentration = nonEmptyRows;
                        }
                    }
                });

                if (this.data.ciConcentration.length === 0 && this.data.creConcentration.length === 0) {
                    throw new Error('No valid concentration data found. Please ensure your Excel file contains C&I Concentration and/or CRE Concentration sheets.');
                }
            }

            parseNumber(value) {
                if (typeof value === 'number') return value;
                if (typeof value === 'string') {
                    // Handle percentages - if it contains %, parse as percentage
                    if (value.includes('%')) {
                        const num = parseFloat(value.replace(/[,$%]/g, ''));
                        return isNaN(num) ? 0 : num; // Return as decimal (e.g., 75% becomes 75, not 0.75)
                    }
                    // Handle regular numbers
                    const num = parseFloat(value.replace(/[,$]/g, ''));
                    return isNaN(num) ? 0 : num;
                }
                return 0;
            }

            processAllData() {
                this.processData();
                this.processCREData();
                this.processOverviewData();
            }

            processData() {
                this.metrics = {
                    totalIndustries: this.data.ciConcentration.length,
                    totalBookBalance: this.data.ciConcentration.reduce((sum, item) => sum + (item["Sum of Net Curr Book Balance"] || 0), 0),
                    totalExposure: this.data.ciConcentration.reduce((sum, item) => sum + (item["Sum of TotalExp"] || 0), 0),
                    averageCapitalRatio: this.data.ciConcentration.length > 0 ? 
                        this.data.ciConcentration.reduce((sum, item) => sum + (item["Book as % of Capital"] || 0), 0) / this.data.ciConcentration.length : 0,
                    highRiskIndustries: this.data.ciConcentration.filter(item => (item["Book as % of Capital"] || 0) > 0.15).length
                };

                this.data.ciConcentration.sort((a, b) => (b["Sum of Net Curr Book Balance"] || 0) - (a["Sum of Net Curr Book Balance"] || 0));
            }

            processCREData() {
                this.creMetrics = {
                    totalProperties: this.data.creConcentration.length,
                    totalCREBalance: this.data.creConcentration.reduce((sum, item) => sum + (item["Outstanding Balance"] || 0), 0),
                    totalCRELoans: this.data.creConcentration.reduce((sum, item) => sum + (item["Number of Loans"] || 0), 0),
                    averageLTV: this.data.creConcentration.length > 0 ? 
                        this.data.creConcentration.reduce((sum, item) => sum + (item["Average LTV"] || 0), 0) / this.data.creConcentration.length : 0,
                    highRiskProperties: this.data.creConcentration.filter(item => (item["Average LTV"] || 0) > 80).length
                };

                this.data.creConcentration.sort((a, b) => (b["Outstanding Balance"] || 0) - (a["Outstanding Balance"] || 0));
            }

            processOverviewData() {
                const totalCIBalance = this.data.ciConcentration.reduce((sum, item) => sum + (item["Sum of Net Curr Book Balance"] || 0), 0);
                const totalCREBalance = this.data.creConcentration.reduce((sum, item) => sum + (item["Outstanding Balance"] || 0), 0);
                
                this.overviewMetrics = {
                    totalPortfolio: totalCIBalance + totalCREBalance,
                    ciPercentage: totalCIBalance / (totalCIBalance + totalCREBalance) * 100,
                    crePercentage: totalCREBalance / (totalCIBalance + totalCREBalance) * 100,
                    classifiedLoansCount: this.data.classifiedLoans.length,
                    nonAccrualCount: this.data.nonAccrualLoans.length
                };
            }

            renderAllContent() {
                this.renderCIContent();
                if (this.data.creConcentration.length > 0) {
                    this.renderCREContent();
                }
                this.renderOverviewContent();
            }

            renderCIContent() {
                this.renderCIMetrics();
                this.renderCICharts();
                this.renderCITable();
            }

            renderCREContent() {
                this.renderCREMetrics();
                this.renderCRECharts();
                this.renderCRETable();
            }

            renderOverviewContent() {
                this.renderOverviewMetrics();
                this.renderOverviewCharts();
            }

            switchSheet(sheetType) {
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-sheet="${sheetType}"]`).classList.add('active');
                
                document.querySelectorAll('.sheet-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${sheetType}-content`).classList.add('active');
                
                this.currentSheet = sheetType;
            }

            renderCIMetrics() {
                const metricsGrid = document.getElementById('ci-metrics-grid');
                const metrics = [
                    {
                        value: this.metrics.totalIndustries,
                        label: 'C&I Industries'
                    },
                    {
                        value: `$${(this.metrics.totalBookBalance / 1000000).toFixed(1)}M`,
                        label: 'C&I Book Balance'
                    },
                    {
                        value: `$${(this.metrics.totalExposure / 1000000).toFixed(1)}M`,
                        label: 'C&I Total Exposure'
                    },
                    {
                        value: `${(this.metrics.averageCapitalRatio * 100).toFixed(1)}%`,
                        label: 'Avg Capital Ratio'
                    },
                    {
                        value: this.metrics.highRiskIndustries,
                        label: 'High Risk Industries'
                    }
                ];

                metricsGrid.innerHTML = metrics.map(metric => `
                    <div class="metric-card">
                        <div class="metric-value">${metric.value}</div>
                        <div class="metric-label">${metric.label}</div>
                    </div>
                `).join('');
            }

            renderCREMetrics() {
                const metricsGrid = document.getElementById('cre-metrics-grid');
                
                // Format total loans properly
                const totalLoans = this.creMetrics.totalCRELoans;
                let formattedTotalLoans;
                if (totalLoans >= 1000000) {
                    formattedTotalLoans = `${(totalLoans / 1000000).toFixed(1)}M`;
                } else if (totalLoans >= 1000) {
                    formattedTotalLoans = `${(totalLoans / 1000).toFixed(1)}K`;
                } else {
                    formattedTotalLoans = Math.round(totalLoans).toString();
                }

                const metrics = [
                    {
                        value: this.creMetrics.totalProperties,
                        label: 'Property Types'
                    },
                    {
                        value: `${(this.creMetrics.totalCREBalance / 1000000).toFixed(1)}M`,
                        label: 'CRE Portfolio'
                    },
                    {
                        value: formattedTotalLoans,
                        label: 'Total CRE Loans'
                    },
                    {
                        value: `${this.creMetrics.averageLTV.toFixed(1)}%`,
                        label: 'Average LTV'
                    },
                    {
                        value: this.creMetrics.highRiskProperties,
                        label: 'High LTV Properties'
                    }
                ];

                metricsGrid.innerHTML = metrics.map(metric => `
                    <div class="metric-card">
                        <div class="metric-value">${metric.value}</div>
                        <div class="metric-label">${metric.label}</div>
                    </div>
                `).join('');
            }

            renderOverviewMetrics() {
                const metricsGrid = document.getElementById('overview-metrics-grid');
                const metrics = [
                    {
                        value: `$${(this.overviewMetrics.totalPortfolio / 1000000).toFixed(1)}M`,
                        label: 'Total Portfolio'
                    },
                    {
                        value: `${this.overviewMetrics.ciPercentage.toFixed(1)}%`,
                        label: 'C&I Allocation'
                    },
                    {
                        value: `${this.overviewMetrics.crePercentage.toFixed(1)}%`,
                        label: 'CRE Allocation'
                    },
                    {
                        value: this.overviewMetrics.classifiedLoansCount,
                        label: 'Classified Loans'
                    },
                    {
                        value: this.overviewMetrics.nonAccrualCount,
                        label: 'Non-Accrual Assets'
                    }
                ];

                metricsGrid.innerHTML = metrics.map(metric => `
                    <div class="metric-card">
                        <div class="metric-value">${metric.value}</div>
                        <div class="metric-label">${metric.label}</div>
                    </div>
                `).join('');
            }

            renderCICharts() {
                this.renderCIIndustryChart();
                this.renderCICapitalChart();
                this.renderCIRiskChart();
                this.renderCICapacityChart();
            }

            renderCRECharts() {
    this.renderCRETypeChart();
    this.renderCREGeoChart();
    this.renderCRERiskChart();
    this.renderCRELtvChart(); // <- Add the correct function here
}


            renderOverviewCharts() {
                this.renderPortfolioCompositionChart();
                this.renderRiskComparisonChart();
                this.renderLimitsChart();
                this.renderProblemAssetsChart();
            }

            renderCIIndustryChart() {
                const ctx = document.getElementById('ciIndustryChart').getContext('2d');
                const top10Industries = this.data.ciConcentration.slice(0, 10);
                
                if (this.charts.ciIndustry) this.charts.ciIndustry.destroy();
                
                this.charts.ciIndustry = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: top10Industries.map(item => item["Row Labels"]),
                        datasets: [{
                            data: top10Industries.map(item => item["Sum of Net Curr Book Balance"] / 1000000),
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                                '#4BC0C0', '#FF6384'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 12,
                                    padding: 10
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed.toFixed(1)}M`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderCICapitalChart() {
                const ctx = document.getElementById('ciCapitalChart').getContext('2d');
                const top10Industries = this.data.ciConcentration.slice(0, 10);
                
                if (this.charts.ciCapital) this.charts.ciCapital.destroy();
                
                this.charts.ciCapital = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: top10Industries.map(item => item["Row Labels"]),
                        datasets: [{
                            label: 'Capital Utilization %',
                            data: top10Industries.map(item => (item["Book as % of Capital"] || 0) * 100),
                            backgroundColor: top10Industries.map(item => {
                                const ratio = item["Book as % of Capital"] || 0;
                                if (ratio > 0.25) return '#e74c3c';
                                if (ratio > 0.15) return '#f39c12';
                                return '#27ae60';
                            }),
                            borderWidth: 1,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Percentage of Capital'
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y.toFixed(2)}% of capital`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderCIRiskChart() {
                const ctx = document.getElementById('ciRiskChart').getContext('2d');
                
                const riskCategories = {
                    low: this.data.ciConcentration.filter(item => (item["Book as % of Capital"] || 0) <= 0.10).length,
                    medium: this.data.ciConcentration.filter(item => (item["Book as % of Capital"] || 0) > 0.10 && (item["Book as % of Capital"] || 0) <= 0.20).length,
                    high: this.data.ciConcentration.filter(item => (item["Book as % of Capital"] || 0) > 0.20).length
                };

                if (this.charts.ciRisk) this.charts.ciRisk.destroy();

                this.charts.ciRisk = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Low Risk (≤10%)', 'Medium Risk (10-20%)', 'High Risk (>20%)'],
                        datasets: [{
                            data: [riskCategories.low, riskCategories.medium, riskCategories.high],
                            backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed} industries`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderCICapacityChart() {
                const ctx = document.getElementById('ciCapacityChart').getContext('2d');
                const top10Industries = this.data.ciConcentration.slice(0, 10);
                
                if (this.charts.ciCapacity) this.charts.ciCapacity.destroy();
                
                this.charts.ciCapacity = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: top10Industries.map(item => item["Row Labels"]),
                        datasets: [
                            {
                                label: 'Used Capacity',
                                data: top10Industries.map(item => ((item["% to Cap"] || 0) * 100)),
                                backgroundColor: '#3498db',
                                borderWidth: 1
                            },
                            {
                                label: 'Available Capacity',
                                data: top10Industries.map(item => (100 - ((item["% to Cap"] || 0) * 100))),
                                backgroundColor: '#ecf0f1',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                ticks: {
                                    maxRotation: 45
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Capacity Utilization %'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderCRETypeChart() {
                const ctx = document.getElementById('creTypeChart').getContext('2d');
                const top8Properties = this.data.creConcentration.slice(0, 8);
                
                if (this.charts.creType) this.charts.creType.destroy();
                
                this.charts.creType = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: top8Properties.map(item => item["Property Type"]),
                        datasets: [{
                            label: 'Outstanding Balance ($M)',
                            data: top8Properties.map(item => (item["Outstanding Balance"] || 0) / 1000000),
                            backgroundColor: '#2980b9',
                            borderWidth: 1,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Outstanding Balance ($M)'
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y.toFixed(1)}M`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderCREGeoChart() {
                const ctx = document.getElementById('creGeoChart').getContext('2d');
                
                if (this.charts.creGeo) this.charts.creGeo.destroy();
                
                this.charts.creGeo = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: this.data.creConcentration.map(item => item["Property Type"]),
                        datasets: [{
                            data: this.data.creConcentration.map(item => item["Number of Loans"] || 0),
                            backgroundColor: [
                                '#e74c3c', '#3498db', '#2ecc71', '#f39c12',
                                '#9b59b6', '#1abc9c', '#e67e22', '#95a5a6'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 12,
                                    padding: 8
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed} loans`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderCRERiskChart() {
                const ctx = document.getElementById('creRiskChart').getContext('2d');
                
                const riskCategories = {
                    low: this.data.creConcentration.filter(item => (item["Average LTV"] || 0) <= 70).length,
                    medium: this.data.creConcentration.filter(item => (item["Average LTV"] || 0) > 70 && (item["Average LTV"] || 0) <= 80).length,
                    high: this.data.creConcentration.filter(item => (item["Average LTV"] || 0) > 80).length
                };

                if (this.charts.creRisk) this.charts.creRisk.destroy();

                this.charts.creRisk = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Low Risk (≤70% LTV)', 'Medium Risk (70-80% LTV)', 'High Risk (>80% LTV)'],
                        datasets: [{
                            data: [riskCategories.low, riskCategories.medium, riskCategories.high],
                            backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed} properties`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderCRELtvChart() {
    const ctx = document.getElementById('creLtvChart').getContext('2d');

    if (this.charts.creLtv) this.charts.creLtv.destroy();

    // Get raw LTV values (already in percentage like 0.5%)
    const ltvValues = this.data.creConcentration.map(item => item["Average LTV"] || 0);

    // Dynamically calculate max Y-axis value (e.g., 0.6% → max 1%)
    const maxLtvValue = Math.max(...ltvValues);
    const yAxisMax = Math.ceil((maxLtvValue + 0.1) * 10) / 10; // round up to next 0.1%

    this.charts.creLtv = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: this.data.creConcentration.map(item => item["Property Type"]),
            datasets: [{
                label: 'Average LTV %',
                data: ltvValues,
                backgroundColor: ltvValues.map(ltv => {
                    if (ltv > 80) return '#e74c3c';
                    if (ltv > 70) return '#f39c12';
                    return '#27ae60';
                }),
                borderWidth: 1,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: yAxisMax,
                    title: {
                        display: true,
                        text: 'Loan-to-Value Ratio (%)'
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `LTV: ${context.parsed.y.toFixed(1)}%`;
                        }
                    }
                }
            }
        }
    });
}



            renderPortfolioCompositionChart() {
                const ctx = document.getElementById('portfolioCompositionChart').getContext('2d');
                
                if (this.charts.portfolioComposition) this.charts.portfolioComposition.destroy();
                
                this.charts.portfolioComposition = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['C&I Loans', 'CRE Loans'],
                        datasets: [{
                            data: [this.overviewMetrics.ciPercentage, this.overviewMetrics.crePercentage],
                            backgroundColor: ['#3498db', '#e74c3c'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed.toFixed(1)}%`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderRiskComparisonChart() {
                const ctx = document.getElementById('riskComparisonChart').getContext('2d');
                
                const ciHighRisk = this.data.ciConcentration.filter(item => (item["Book as % of Capital"] || 0) > 0.20).length;
                const ciMediumRisk = this.data.ciConcentration.filter(item => (item["Book as % of Capital"] || 0) > 0.10 && (item["Book as % of Capital"] || 0) <= 0.20).length;
                const ciLowRisk = this.data.ciConcentration.filter(item => (item["Book as % of Capital"] || 0) <= 0.10).length;
                
                const creHighRisk = this.data.creConcentration.filter(item => (item["Average LTV"] || 0) > 80).length;
                const creMediumRisk = this.data.creConcentration.filter(item => (item["Average LTV"] || 0) > 70 && (item["Average LTV"] || 0) <= 80).length;
                const creLowRisk = this.data.creConcentration.filter(item => (item["Average LTV"] || 0) <= 70).length;

                if (this.charts.riskComparison) this.charts.riskComparison.destroy();
                
                this.charts.riskComparison = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                        datasets: [
                            {
                                label: 'C&I Industries',
                                data: [ciLowRisk, ciMediumRisk, ciHighRisk],
                                backgroundColor: '#3498db',
                                borderWidth: 1
                            },
                            {
                                label: 'CRE Properties',
                                data: [creLowRisk, creMediumRisk, creHighRisk],
                                backgroundColor: '#e74c3c',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Assets'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderLimitsChart() {
                const ctx = document.getElementById('limitsChart').getContext('2d');
                
                if (this.charts.limits) this.charts.limits.destroy();
                
                const top5CI = this.data.ciConcentration.slice(0, 5);
                
                this.charts.limits = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: top5CI.map(item => item["Row Labels"]),
                        datasets: [
                            {
                                label: 'Current Exposure',
                                data: top5CI.map(item => (item["Book as % of Capital"] || 0) * 100),
                                backgroundColor: '#3498db',
                                borderWidth: 1
                            },
                            {
                                label: 'Regulatory Limit (35%)',
                                data: new Array(5).fill(35),
                                backgroundColor: '#e74c3c',
                                borderWidth: 1,
                                type: 'line'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 40,
                                title: {
                                    display: true,
                                    text: 'Percentage of Capital'
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderProblemAssetsChart() {
                const ctx = document.getElementById('problemAssetsChart').getContext('2d');
                
                if (this.charts.problemAssets) this.charts.problemAssets.destroy();
                
                this.charts.problemAssets = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Classified Loans', 'Non-Accrual Loans'],
                        datasets: [{
                            label: 'Count',
                            data: [this.overviewMetrics.classifiedLoansCount, this.overviewMetrics.nonAccrualCount],
                            backgroundColor: ['#f39c12', '#e74c3c'],
                            borderWidth: 1,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Assets'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed.y}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderCITable() {
                const tableBody = document.getElementById('ciIndustryTableBody');
                
                tableBody.innerHTML = this.data.ciConcentration.map(item => {
                    const capitalRatio = (item["Book as % of Capital"] || 0) * 100;
                    let riskClass = 'risk-low';
                    let riskLevel = 'Low';
                    
                    if (capitalRatio > 20) {
                        riskClass = 'risk-high';
                        riskLevel = 'High';
                    } else if (capitalRatio > 10) {
                        riskClass = 'risk-medium';
                        riskLevel = 'Medium';
                    }

                    return `
                        <tr>
                            <td>${item["Row Labels"] || 'N/A'}</td>
                            <td>${((item["Sum of Net Curr Book Balance"] || 0) / 1000000).toFixed(2)}M</td>
                            <td>${((item["Sum of TotalExp"] || 0) / 1000000).toFixed(2)}M</td>
                            <td>${capitalRatio.toFixed(2)}%</td>
                            <td class="${riskClass}">${riskLevel}</td>
                            <td>${((item["Remaining Lending Limit "] || 0) / 1000000).toFixed(2)}M</td>
                        </tr>
                    `;
                }).join('');
            }

            renderCRETable() {
                const tableBody = document.getElementById('creTableBody');
                
                tableBody.innerHTML = this.data.creConcentration.map(item => {
                    const ltv = item["Average LTV"] || 0;
                    let riskClass = 'risk-low';
                    let riskLevel = 'Low';
                    
                    if (ltv > 80) {
                        riskClass = 'risk-high';
                        riskLevel = 'High';
                    } else if (ltv > 70) {
                        riskClass = 'risk-medium';
                        riskLevel = 'Medium';
                    }

                    const portfolioPercentage = this.creMetrics.totalCREBalance > 0 ? 
                        ((item["Outstanding Balance"] || 0) / this.creMetrics.totalCREBalance * 100) : 0;

                    return `
                        <tr>
                            <td>${item["Property Type"] || 'N/A'}</td>
                            <td>${((item["Outstanding Balance"] || 0) / 1000000).toFixed(2)}M</td>
                            <td>${((item["Number of Loans"] || 0) / 1000000).toFixed(2)}M</td>
                            <td>${portfolioPercentage.toFixed(2)}%</td>
                            <td>${ltv.toFixed(1)}%</td>
                            <td class="${riskClass}">${riskLevel}</td>
                        </tr>
                    `;
                }).join('');
            }

            showDashboard() {
                document.getElementById('file-upload').style.display = 'none';
                document.getElementById('loading').style.display = 'none';
                document.getElementById('navigation').style.display = 'flex';
                document.getElementById('dashboard-content').style.display = 'block';
            }

            showError(message) {
                document.getElementById('file-upload').style.display = 'none';
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-container').innerHTML = `
                    <div class="error-message">
                        <h3>Error Loading Dashboard</h3>
                        <p>${message}</p>
                        <p>Please ensure your Excel file contains the expected sheet structure with C&I Concentration and/or CRE Concentration data.</p>
                        <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">Try Again</button>
                    </div>
                `;
            }

            exportToCSV(dataType) {
                let csvContent = '';
                let filename = '';

                if (dataType === 'ci') {
                    csvContent = 'Industry,Book Balance,Total Exposure,Capital Ratio,Risk Level,Remaining Capacity\n';
                    this.data.ciConcentration.forEach(item => {
                        const capitalRatio = (item["Book as % of Capital"] || 0) * 100;
                        const riskLevel = capitalRatio > 20 ? 'High' : capitalRatio > 10 ? 'Medium' : 'Low';
                        
                        csvContent += `"${item["Row Labels"] || 'N/A'}",`;
                        csvContent += `${((item["Sum of Net Curr Book Balance"] || 0) / 1000000).toFixed(2)},`;
                        csvContent += `${((item["Sum of TotalExp"] || 0) / 1000000).toFixed(2)},`;
                        csvContent += `${capitalRatio.toFixed(2)}%,`;
                        csvContent += `${riskLevel},`;
                        csvContent += `${((item["Remaining Lending Limit "] || 0) / 1000000).toFixed(2)}\n`;
                    });
                    filename = 'ci_concentration_analysis.csv';
                } else if (dataType === 'cre') {
                    csvContent = 'Property Type,Outstanding Balance,Number of Loans,Portfolio Percentage,Average LTV,Risk Level\n';
                    this.data.creConcentration.forEach(item => {
                        const ltv = item["Average LTV"] || 0;
                        const riskLevel = ltv > 80 ? 'High' : ltv > 70 ? 'Medium' : 'Low';
                        const portfolioPercentage = this.creMetrics.totalCREBalance > 0 ? 
                            ((item["Outstanding Balance"] || 0) / this.creMetrics.totalCREBalance * 100) : 0;

                        csvContent += `"${item["Property Type"] || 'N/A'}",`;
                        csvContent += `${((item["Outstanding Balance"] || 0) / 1000000).toFixed(2)},`;
                        csvContent += `${item["Number of Loans"] || 0},`;
                        csvContent += `${portfolioPercentage.toFixed(2)}%,`;
                        csvContent += `${ltv.toFixed(1)}%,`;
                        csvContent += `${riskLevel}\n`;
                    });
                    filename = 'cre_concentration_analysis.csv';
                }

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const dashboard = new BankingDashboard();
            dashboard.init();
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (window.dashboard && e.ctrlKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        window.dashboard.switchSheet('ci');
                        break;
                    case '2':
                        e.preventDefault();
                        window.dashboard.switchSheet('cre');
                        break;
                    case '3':
                        e.preventDefault();
                        window.dashboard.switchSheet('overview');
                        break;
                    case 'e':
                        e.preventDefault();
                        if (window.dashboard.currentSheet === 'ci') {
                            window.dashboard.exportToCSV('ci');
                        } else if (window.dashboard.currentSheet === 'cre') {
                            window.dashboard.exportToCSV('cre');
                        }
                        break;
                }
            }
        });

        // Add window resize handler for responsive charts
        window.addEventListener('resize', () => {
            if (window.dashboard && window.dashboard.charts) {
                Object.values(window.dashboard.charts).forEach(chart => {
                    if (chart && typeof chart.resize === 'function') {
                        chart.resize();
                    }
                });
            }
        });
    </script>
</body>
</html>